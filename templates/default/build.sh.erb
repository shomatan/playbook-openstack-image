#!/usr/bin/bash -x
# Managed by chef

rm -f build.log
virsh destroy <%= @instance_name %>
virsh undefine <%= @instance_name %>

if [ ! -e <%= @tmp_file %> ]; then
  qemu-img create -f <%= @format %> <%= @tmp_file %> 10G
fi

virt-install \
  --virt-type <%= @virt_type %> \
  --name <%= @instance_name %> \
<% if @format == 'kvm' %>
  --vcpus <%= node['cpu']['cores'] %> \
<% else %>
  --vcpus 1 \
<% end %>
  --ram 1024 \
  --nographics --noautoconsole --noreboot \
  --disk <%= @tmp_file %>,format=<%= @format %> \
  --network network=default \
  --os-type=linux --os-variant=rhel7 \
  --location=<%= @os_location %> \
  --initrd-inject <%= @kickstart_file %> \
  --extra-args="ks=file:/ks.cfg console=tty0 console=ttyS0,115200n8 serial"

sleep 5

virsh console <%= @instance_name %>
virt-sysprep -d <%= @instance_name %> >> build.log
virt-sparsify --compress <%= @tmp_file %> <%= @output_file %> >> build.log
virsh undefine <%= @instance_name %> >> build.log

echo "Build.sh completed!" >> build.log
